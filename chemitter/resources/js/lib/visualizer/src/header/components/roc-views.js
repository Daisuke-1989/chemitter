"use strict";function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();define(["jquery","lodash","superagent","src/header/components/default","src/util/util","src/util/ui","src/util/debug","src/util/roc-view","src/util/versioning","src/util/couchdbAttachments","src/util/uploadUi","fancytree","components/ui-contextmenu/jquery.ui-contextmenu.min","jquery-ui/accordion"],function(a,b,c,d,e,f,g,h,i,j,k){function l(a){return a.body}function m(a,b){return a.folder===b.folder?a.title.localeCompare(b.title):a.folder?-1:1}function n(a,b,c,d){var e=a.get(c);e||(e=new Map,a.set(c,e));for(var f=0;f<d.length-1;f++)e.has(d[f])||e.set(d[f],new Map),e=e.get(d[f]);e.set(d[f],b)}function o(a){return a=a.trim(),a.length>0?a:!1}function p(a){return a=a.trim(),/^[a-zA-Z0-9$_-]+$/.test(a)?a:!1}function q(){var a=i.getView(),b=i.getViewJSON(),c=(a.configuration?a.configuration.title:"")||"";return{version:a.version,title:c,attachment:{content_type:"application/json",data:btoa(unescape(encodeURIComponent(b)))}}}var r=52428800,s={color:"blue",cursor:"pointer",textDecoration:"underline"},t=b.template('<table>\n    <tr>\n        <td style="vertical-align: top;"><b>Document id</b></td>\n        <td><%= view.id %></td>\n    </tr>\n    <tr>\n        <td style="vertical-align: top;"><b>Flavor</b></td>\n        <td><%= flavor %></td>\n    </tr>\n    <tr>\n        <td style="vertical-align: top;"><b>Name</b></td>\n        <td><% print(flavors[flavors.length-1]) %></td>\n    </tr>\n    <tr>\n        <td style="vertical-align: top;"><b>Location</b></td>\n        <td><li><% print(flavors.join(\'</li><li>\')) %></li></td>\n    </tr>\n</table>'),u=function(d){function u(){return _classCallCheck(this,u),_possibleConstructorReturn(this,Object.getPrototypeOf(u).apply(this,arguments))}return _inherits(u,d),_createClass(u,[{key:"initImpl",value:function(){var b=this,c=this.options||{};if(!c.url||!c.database)throw new Error("roc-views: url and database options are mandatory");this.rocUrl=c.url.replace(/\\$/,""),this.rocDatabase=c.database,this.rocDbUrl=this.rocUrl+"/db/"+this.rocDatabase,this.rocReady=!1,this.rocAuthenticated=!1,this.rocUsername=null,this._flavor=null,this.activeNode=null,this.loadedNode=null,this.verifyRoc(),a(document).keydown(function(a){!a.ctrlKey&&!a.metaKey||a.altKey||83!==a.which||(a.preventDefault(),b.saveLoadedView())})}},{key:"_onClick",value:function(){this.rocReady?(this.setStyleOpen(this._open),this._open?(this.createDom(),this.open()):this.close()):(f.showNotification("View database does not respond","error"),g.error("roc-views: unreachable database. Retrying now"),this.verifyRoc())}},{key:"getRequest",value:function(a,b){var d=c.get(this.rocUrl+a).withCredentials();return b&&d.query(b),d}},{key:"getRequestDB",value:function(a,b){return this.getRequest("/db/"+this.rocDatabase+a,b)}},{key:"putRequestDB",value:function(a,b){var d=c.put(this.rocDbUrl+a).withCredentials();return d.send(b),d}},{key:"postRequestDB",value:function(a,b){var d=c.post(this.rocDbUrl+a).withCredentials();return d.send(b),d}},{key:"deleteRequestDB",value:function(a){return c.del(this.rocDbUrl+a).withCredentials()}},{key:"verifyRoc",value:function(){var a=this;return this.getRequest("/auth/session").then(function(b){return 200!==b.statusCode?g.error("roc-views: unable to contact "+a.rocUrl):b.body.ok?(a.rocReady=!0,void(b.body.authenticated&&(a.rocAuthenticated=!0,a.rocUsername=b.body.username,a.getMenuContent()))):g.error("roc-views: unexpected response",b.body)})}},{key:"createDom",value:function(){this.$_elToOpen||(this.$_elToOpen=a("<div>")),this.rocAuthenticated?this.openMenu("tree"):this.openMenu("login")}},{key:"openMenu",value:function(a){a!==this.currentMenu&&("tree"===a?(this.$_elToOpen.html(this.getMenuContent()),this.currentMenu="tree"):"login"===a?(this.$_elToOpen.html(this.getLoginContent()),this.currentMenu="login"):g.error("roc-views: unexpected value for which: "+a))}},{key:"getLoginContent",value:function(){var b=this,c=a("<div>"),d=a("<a>",{text:"here",href:"#",click:function(){return b.login()}});return c.append("Click ").append(d).append(" to login"),c}},{key:"login",value:function(){var a=encodeURIComponent(document.location.href);document.location.href=this.rocUrl+"/auth/login?continue="+a}},{key:"logout",value:function(){var a=this;this.getRequest("/auth/logout").then(function(){a.rocAuthenticated=!1,a.rocUsername=null,a.openMenu("login")})}},{key:"getMenuContent",value:function(){var b=this;if(this.$menuContent)return this.$menuContent;var c=this.$menuContent=a('<div id="root">').css("position","relative"),d=this.$hide=a("<div>").css({position:"absolute",width:"100%",height:"100%",zIndex:2,display:"flex",alignItems:"center",justifyContent:"center"}).hide(),e=a("<div>").css("zIndex",1),f=a("<div>"),g=a("<p>",{css:{display:"inline-block",width:"50%"}});g.append(a("<a>",{click:this.refresh.bind(this),css:s,text:"refresh"}));var h=a("<p>",{css:{display:"inline-block",textAlign:"right",width:"50%"}});h.append(this.rocUsername+" | ").append(a("<a>",{click:this.logout.bind(this),css:s,text:"logout"})),f.append(g).append(h);var i=a("<div>",{css:{marginTop:"20px"}}),j=a("<div>",{css:{verticalAlign:"top",display:"inline-block",width:"360px"}}),k=a("<div></div>",{text:"Search: "}),l="",m=a('<input type="text" size="20">').keyup(function(){var a=m.val();a!==l&&(b.doSearch(a),l=a)});k.append(m);var n=a("<div>"),o=a("<div>",{css:{overflowY:"auto",maxHeight:"500px"}});this.$tree=o,j.append(k).append(n).append(o);var p=a("<div>",{css:{display:"inline-block",height:"100%",marginLeft:"10px",width:"320px"}}),q=this.$title=a("<div>",{css:{width:"100%",textAlign:"center",paddingBottom:"5px"}}),r=a("<div>",{css:{height:"80%",width:"100%"}});r.append("<h3>View information</h3>"),this.$infoBox=a("<div>").appendTo(r),r.append("<h3>Revisions</h3>"),this.$revBox=a("<div>").appendTo(r),this.$revBox.html("coming soon..."),r.append("<h3>Attachments</h3>"),this.$attachmentsBox=a("<div>").appendTo(r);var t=a("<button>Upload attachments</button>").button().click(function(){return b.uploadFiles()});this.$attachmentsBox.html(t),r.append("<h3>Permissions</h3>"),this.$permissionsBox=a("<div>").appendTo(r);var u=this.$publicCheckbox=a('<input type="checkbox" />').click(function(a){a.preventDefault(),b.togglePublic()}),v=a("<div>").append(u).append("Public"),w=this.$ownersList=a("<div>").css({marginTop:"5px",marginBottom:"5px"}),x=a("<button>Add owner</button>").click(function(){return b.addOwner()}),y=a("<div>").append(w).append(x),z=this.$permissionsContainer=a("<div>");this.$permissionsBox.html(z),z.append(v).append(y),r.accordion({heightStyle:"content"});var A=a("<div>",{css:{paddingTop:"20px",height:"20%"}}),B=this.$closeButton=a("<button>Close view</button>").button({disabled:!0}).click(function(){return b.closeLoadedView()}),C=this.$saveButton=a("<button>Save</button>").button({disabled:!0}).click(function(){return b.saveLoadedView()}),D=this.$saveAsButton=a("<button>Save as</button>").button({disabled:!0}).click(function(){return b.saveAs()}),E=this.$saveAsText=a('<input type="text" size="15" />').css("display","none");return A.append(B).append(C).append(D).append(E),p.append(q).append(r).append(A),i.append(j).append(p),e.append(f).append(i),c.append(d).append(e),this.refresh(),c}},{key:"getViews",value:function(){return this.getRequestDB("/entry/_all",{right:"write"}).then(l)}},{key:"refresh",value:function(){var b=this;return this.populateInfo(),this.tree&&(this.$tree.fancytree("destroy"),this.tree=null),this.activeNode=null,this.setLoadedNode(null),this.getViews().then(function(c){var d=b.getTree(c);b.$tree.fancytree({source:d,toggleEffect:!1,debugLevel:0,extensions:["dnd","filter"],dnd:{autoExpandMS:300,preventVoidMoves:!0,preventRecursiveMoves:!0,dragStart:function(a){return b.inSearch?!1:!a.folder},dragEnter:function(a,b){var c=b.otherNode;return a.folder&&a===c.parent?!1:!!a.folder},dragDrop:function(a,c){var d=c.otherNode;b.showHide(!0),d.data.view.moveTo(a).then(function(c){b.showHide(!1),c?d.moveTo(a):f.showNotification("View could not be moved","error")})}},filter:{mode:"hide",fuzzy:!0},activate:function(a,c){return b.onActivate(a,c)},dblclick:function(a,c){return b.onDblclick(a,c)}}),b.$tree.on("mouseenter mouseleave","span.fancytree-title",function(c){var d=a.ui.fancytree.getNode(c);"mouseenter"!==c.type||d.folder?b.populateInfo(b.loadedNode):b.populateInfo(d)}),b.tree=b.$tree.fancytree("getTree"),b.renderFlavor(),b.$tree.contextmenu({delegate:"span.fancytree-title",preventContextMenuForPopup:!0,show:!1,menu:[],beforeOpen:function(c,d){if(b.inSearch)return!1;var e=a.ui.fancytree.getNode(d.target);if(e.folder){var f=e.data.path,g=[{title:"Create folder",cmd:"createFolder",uiIcon:"ui-icon-folder-collapsed"}];if(1===f.length){g.push({title:"New flavor...",cmd:"newFlavor",uiIcon:"ui-icon-document-b"}),g.push({title:"----"});for(var h=b.flavors,i=0;i<h.length;i++)g.push({title:h[i],cmd:"switchFlavor",uiIcon:h[i]===b.flavor?"ui-icon-check":void 0})}b.$tree.contextmenu("replaceMenu",g)}else{for(var j=b.flavors,k=[],l=e.data.view.flavors,i=0;i<j.length;i++){var m=!!l[j[i]];k.push({title:j[i],cmd:"toggleFlavor",uiIcon:m?"ui-icon-check":void 0})}b.$tree.contextmenu("replaceMenu",[{title:"Rename",cmd:"renameView",uiIcon:"ui-icon-pencil"},{title:"Delete",cmd:"deleteView",uiIcon:"ui-icon-trash"},{title:"Flavors",children:k}])}e.setActive()},select:function(c,d){var e=a.ui.fancytree.getNode(d.target),f=void 0;switch(d.cmd){case"createFolder":b.createFolder(e);break;case"deleteView":b.deleteView(e);break;case"renameView":b.renameView(e);break;case"toggleFlavor":f=d.item.text(),b.toggleFlavor(e,f);break;case"switchFlavor":f=d.item.text(),b.switchToFlavor(f);break;case"newFlavor":b.newFlavor();break;default:g.error("unknown action: "+d.cmd)}},createMenu:function(b){a(b.target).css("z-index",1e4)}});var e=i.lastLoaded.view.url,h=/\/([^\/]+)\/view\.json$/,j=h.exec(e);if(j){var k=j[1];b.tree.visit(function(a){return a.data.view&&a.data.view.id===k&&a.data.flavor===b.flavor?(a.getParent().setExpanded(!0),a.setActive(!0),b.setLoadedNode(a),b.populateInfo(a),!1):void 0})}})}},{key:"newFlavor",value:function(){var b=this,c=a("<div>Name of the new flavor: </div>"),d=a('<input type="text" />').appendTo(c).on("keypress",function(a){13===a.keyCode&&e()}),e=function(){var a=p(d.val());return a?(-1===b.flavors.indexOf(a)&&(b.tree.rootNode.addNode({folder:!0,title:a,path:[a]}),b.flavors.push(a),b.flavors.sort()),b.switchToFlavor(a),void g.dialog("destroy")):f.showNotification("Invalid name","error")},g=f.dialog(c,{buttons:{Create:e}})}},{key:"createFolder",value:function(b){var c=this,d=a("<div>Name of the directory: </div>"),e=a('<input type="text" />').appendTo(d).on("keypress",function(a){13===a.keyCode&&g()}),g=function(){var a=o(e.val());if(!a)return f.showNotification("Invalid name","error");var d=b.getChildren();if(d)for(var g=0;g<d.length;g++)if(d[g].title===a&&d[g].folder)return f.showNotification("Folder "+a+" already exists","error");b.setExpanded(!0);var i=b.addNode({folder:!0,title:a,path:b.data.path.concat(a)});b.sortChildren(m),i.setActive(),h.dialog("destroy"),c.renderFlavor()},h=f.dialog(d,{buttons:{Save:g}})}},{key:"deleteView",value:function(a){var b=this;f.confirm('This will delete the view named "'+a.title+'" and all related data.<br>Are you sure?',"Yes, delete it!","Maybe not...").then(function(c){c&&(b.showHide(!0),a.data.view.remove().then(function(c){b.showHide(!1),c?(f.showNotification("View deleted","success"),a.remove(),a===b.loadedNode&&(i.switchView({view:{},data:{}},!0,{doNotLoad:!0}),b.setLoadedNode(null))):f.showNotification("Error while deleting view","error")}))})}},{key:"renameView",value:function(b){var c=this,d=a('<div>Renaming view "'+b.title+'"<br>New name: </div>'),e=a('<input type="text" />').appendTo(d).on("keypress",function(a){13===a.keyCode&&g()}),g=function(){var a=e.val().trim();return 0===a.length?f.showNotification("Name cannot be empty","error"):(c.showHide(!0),b.data.view.rename(b.data.flavor,a).then(function(d){c.showHide(!1),d?(f.showNotification("View was renamed","success"),b.setTitle(a),c.renderLoadedNode()):f.showNotification("Error while renaming view","error"),h.dialog("destroy")}))},h=f.dialog(d,{buttons:{Rename:g}})}},{key:"toggleFlavor",value:function(a,b){var c=this,d=a.data.view;return this.showHide(!0),d.toggleFlavor(b,this.flavor).then(function(a){if(c.showHide(!1),a)if("err-one"===a.state)f.showNotification("Cannot remove the last flavor","error");else if("removed"===a.state){var e=void 0;if(c.tree.rootNode.visit(function(a){return a.data.view===d&&a.data.flavor===b?(e=a,!1):void 0}),!e)throw new Error("Node not found");e.remove(),f.showNotification("Flavor "+b+" removed","success")}else{if("added"!==a.state)throw new Error("unexpected result: "+a);var g=c.tree.rootNode.getChildren(),h=!0,i=!1,j=void 0;try{for(var k,l=g[Symbol.iterator]();!(h=(k=l.next()).done);h=!0){var m=k.value;if(m.title===b){c.addNodeAndSelect(m,{title:a.name,folder:!1,view:d,flavor:b});break}}}catch(a){i=!0,j=a}finally{try{!h&&l.return&&l.return()}finally{if(i)throw j}}c.switchToFlavor(b),f.showNotification("Flavor "+b+" added","success")}else f.showNotification("Error while toggling flavor","error");c.renderLoadedNode()})}},{key:"doSearch",value:function(a){""===a?(this.inSearch=!1,this.tree.clearFilter(),this.renderFlavor()):(this.inSearch=!0,this.tree.filterNodes(a,{autoExpand:!0,leavesOnly:!0}))}},{key:"switchToFlavor",value:function(a){this.flavor!==a&&(this.flavor=a,this.renderFlavor(),this.loadedNode&&!this.loadedNode.data.view.hasFlavor(a)&&this.setLoadedNode(null))}},{key:"renderFlavor",value:function(){var a=this,b=!1;this.tree.filterBranches(function(c){return c.folder&&c.title===a.flavor&&1===c.data.path.length?(b=!0,c.setExpanded(!0),!0):(c.setExpanded(!1),!1)}),b||(this.tree.rootNode.addNode({folder:!0,title:this.flavor,path:[this.flavor]}),this.flavors.push(this.flavor),this.flavors.sort(),this.renderFlavor())}},{key:"onActivate",value:function(a,b){this.activeNode=b.node,b.node.folder?(this.$saveAsButton.button("enable"),this.$saveAsText.show()):(this.$saveAsButton.button("disable"),this.$saveAsText.hide())}},{key:"populateInfo",value:function(a){if(!a)return this.$title.html("&nbsp;"),this.$infoBox.empty(),void this.$permissionsContainer.hide();var c=a.data.view;this.$title.text(c.title),this.$infoBox.html("Name: <b>"+b.escape(a.title)+"</b><br>\n                Folder: "+c.getPath(a.data.flavor)+"<br>\n                Visualizer version: "+c.version+"<br><br>\n                Size: "+e.formatSize(c.size)+"<br>\n                Id: "+c.id+"<br>\n                Revision: "+c.revid+"<br><br>\n                Created on: "+c.creationDate.toLocaleString()+"<br>\n                Last modified: "+c.modificationDate.toLocaleString()+"<br>\n                Owner: "+c.owner),this.$permissionsContainer.show(),this.$publicCheckbox.prop("checked",c.public),this.$ownersList.html("Owners: "+c.owners.join(", "))}},{key:"saveAs",value:function(){var a=this,b=this.activeNode;if(b.folder){for(var c=this.$saveAsText.val().split("/"),d=0;d<c.length;d++){var e=o(c[d]);if(!e)return f.showNotification("Invalid name","error");c[d]=e}a:for(var g=0;g<c.length-1;g++){var j=c[g],k=b.getChildren();if(k)for(var l=0;l<k.length;l++)if(k[l].title===j&&k[l].folder){b=k[l];continue a}b.setExpanded(!0);var n=b.addNode({folder:!0,title:j,path:b.data.path.concat(j)});b.sortChildren(m),b=n}var p=c[c.length-1],r=q(),s=this.flavor,t={$kind:"view",$content:{version:r.version,title:r.title,flavors:_defineProperty({},s,b.data.path.slice(1).concat(p))},_attachments:{"view.json":r.attachment}},u=new h(t,this);this.showHide(!0),u.save().then(function(){a.showHide(!1),f.showNotification("View saved","success"),a.addNodeAndSelect(b,{title:p,folder:!1,view:u,flavor:s}),i.switchView(u.getViewSwitcher(),!0,{doNotLoad:!0})},function(b){a.showHide(!1),f.showNotification("View could not be saved","error")})}}},{key:"closeLoadedView",value:function(){this.loadedNode&&(i.switchView({view:{},data:{}},!0),this.setLoadedNode(null))}},{key:"saveLoadedView",value:function(){var a=this;this.loadedNode?!function(){var b=f.dialog(t({view:a.loadedNode.data.view,flavor:a.loadedNode.data.flavor,flavors:a.loadedNode.data.view.flavors[a.loadedNode.data.flavor]}),{width:"400px",buttons:{Save:function(){b.dialog("close"),a.showHide(!0),a.loadedNode.data.view.saveView(q()).then(function(b){a.showHide(!1),b?(f.showNotification("View saved","success"),a.renderLoadedNode()):f.showNotification("View could not be saved","error")})}}})}():f.showNotification("No view loaded in view manager","error")}},{key:"onDblclick",value:function(a,b){var c=b.node;if(!c.folder){var d=c.data.flavor;this.switchToFlavor(d),this.inSearch&&this.doSearch(""),c.setActive(!0),this.setLoadedNode(c);var e=c.data.view;i.switchView(e.getViewSwitcher(),!0,{withCredentials:!0})}}},{key:"getTree",value:function(a){for(var b=new Map,c=new Set,d=0;d<a.length;d++){var e=new h(a[d],this);for(var f in e.content.flavors)c.add(f),n(b,e,f,e.content.flavors[f])}this.flavors=Array.from(c).sort();var g=[],i=!0,j=!1,k=void 0;try{for(var l,o=b[Symbol.iterator]();!(i=(l=o.next()).done);i=!0){var p=l.value;this.buildElement(g,p[0],p[1],[p[0]],!0,p[0])}}catch(a){j=!0,k=a}finally{try{!i&&o.return&&o.return()}finally{if(j)throw k}}return g.sort(m),g}},{key:"buildFolder",value:function(a,b,c,d,e){var f=!0,g=!1,h=void 0;try{for(var i,j=b[Symbol.iterator]();!(f=(i=j.next()).done);f=!0){var k=i.value;this.buildElement(a,k[0],k[1],c.concat(k[0]),d,e)}}catch(a){g=!0,h=a}finally{try{!f&&j.return&&j.return()}finally{if(g)throw h}}a.sort(m)}},{key:"buildElement",value:function(a,b,c,d,e,f){if(c instanceof Map){var g={title:b,folder:!0,children:[],path:d};e&&b===this.flavor&&(g.expanded=!0),this.buildFolder(g.children,c,d,!1,f),a.push(g)}else a.push({title:b,folder:!1,view:c,flavor:f})}},{key:"addNodeAndSelect",value:function(a,b){var c=a.addNode(b);return a.sortChildren(m),a.setExpanded(!0),c.setActive(!0),this.renderFlavor(),this.setLoadedNode(c),c}},{key:"setLoadedNode",value:function(a){this.loadedNode=a,a?(this.$saveButton.button("enable"),this.$closeButton.button("enable")):(this.$saveButton.button("disable"),this.$closeButton.button("disable")),this.renderLoadedNode()}},{key:"renderLoadedNode",value:function(){this.populateInfo(this.loadedNode)}},{key:"showHide",value:function(a){var b=this;clearTimeout(this._showTimeout),a?(this.$hide.show(),this._showTimeout=setTimeout(function(){b.$hide.html(e.getLoadingAnimation())},1e3)):(this.$hide.empty(),this.$hide.hide())}},{key:"uploadFiles",value:function(){var a=this;if(this.loadedNode){var c=this.rocDbUrl+"/entry/"+this.loadedNode.data.view.id,d=new j(c);return d.fetchList().then(function(e){return k.uploadDialog(e,{mode:"couch",docUrl:c}).then(function(c){if(c&&0!==c.length){a.showHide(!0);var e;e=b.partition(c,function(a){return a.toDelete});var g=e[0];e=b.partition(e[1],function(a){return a.size<r});var h=e[1],i=e[0];i.sort(function(a,b){return a.size<b.size?1:a.size===b.size?0:-1});var j,k=[],l=[],m=0;for(j=0;j<i.length;j++)m+=i[j].size,r>m?l.push(i[j]):(k.push(l),l=[i[j]],m=i[j].size);l.length&&k.push(l);var n=Promise.resolve();for(n=n.then(function(){return d.remove(b.map(g,"name"))}),j=0;j<h.length;j++)!function(a){n=n.then(function(){return d.upload(h[a])})}(j);for(j=0;j<k.length;j++)!function(a){n=n.then(function(){return d.inlineUploads(k[a])})}(j);return n=n.then(function(){a.showHide(!1),f.showNotification("Files uploaded successfully","success")},function(b){a.showHide(!1),f.showNotification("Files upload failed (at least partially)","error"),console.error(b.message,b.stack)}),n.then(function(){return a.reloadCurrent()})}})})}}},{key:"reloadCurrent",value:function(){var a=this;if(this.loadedNode)return this.loadedNode.data.view.reload().then(function(){return a.renderLoadedNode()})}},{key:"togglePublic",value:function(){var a=this;if(this.loadedNode)return this.showHide(!0),this.loadedNode.data.view.togglePublic().then(function(b){a.showHide(!1),a.renderLoadedNode(),b||f.showNotification("Could not change permissions","error")})}},{key:"addOwner",value:function(){var b=this;if(this.loadedNode)var c=a("<div>User email address: </div>"),d=a('<input type="text" />').appendTo(c).on("keypress",function(a){13===a.keyCode&&g()}),g=function(){var a=d.val();return e.isEmail(a)?(b.showHide(!0),b.loadedNode.data.view.addGroup(a).then(function(a){a||f.showNotification("Could not add owner","error"),b.renderLoadedNode(),b.showHide(!1)}),void h.dialog("destroy")):f.showNotification("Invalid email","error")},h=f.dialog(c,{buttons:{Add:g}})}},{key:"flavor",get:function(){return this._flavor?this._flavor:this._flavor=window.sessionStorage.getItem("ci-visualizer-roc-views-flavor")||"default"},set:function(a){this._flavor=a,window.sessionStorage.setItem("ci-visualizer-roc-views-flavor",a)}}]),u}(d);return u});