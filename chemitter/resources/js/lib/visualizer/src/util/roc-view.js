"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();define(["./util"],function(a){function b(){return!0}function c(){return!1}var d="anonymousRead",e=function(){function e(a,b){_classCallCheck(this,e),this.view=a,this.manager=b}return _createClass(e,[{key:"getPath",value:function(a){var b=this.flavors[a].slice(0,-1);return"/"+b.join("/")}},{key:"hasFlavor",value:function(a){return!!this.flavors[a]}},{key:"hasView",value:function(){return this.view._attachments&&this.view._attachments["view.json"]}},{key:"hasData",value:function(){return this.view._attachments&&this.view._attachments["data.json"]}},{key:"getViewUrl",value:function(){return this.hasView()?this.manager.rocDbUrl+"/entry/"+this.id+"/view.json":null}},{key:"getDataUrl",value:function(){return this.hasData()?this.manager.rocDbUrl+"/entry/"+this.id+"/data.json":null}},{key:"getViewSwitcher",value:function(){return{view:{url:this.getViewUrl()},data:{url:this.getDataUrl()}}}},{key:"moveTo",value:function(a){var d=a.data.path,e=d[0],f=this.flavors[e],g=f[f.length-1];return this.flavors[e]=d.slice(1).concat(g),this.save().then(b,c)}},{key:"save",value:function(){var a=this,b=function(b){return a.view._id=b.body.id,a.reload().catch(function(){a.view._rev=b.body.rev,a.view.$modificationDate=b.body.$modificationDate,a.view.$creationDate=b.body.$creationDate})};return this.id?this.manager.putRequestDB("/entry/"+this.id,this.view).then(b):this.manager.postRequestDB("/entry/",this.view).then(b)}},{key:"saveView",value:function(a){var c=this,d=this.title,e=this.version,f=void 0;return this.hasView()&&(f=this.view._attachments["view.json"]),this.content.title=a.title,this.content.version=a.version,this.view._attachments||(this.view._attachments={}),this.view._attachments["view.json"]=a.attachment,this.save().then(b,function(){return c.content.title=d,c.content.version=e,f&&(c.view._attachments["view.json"]=f),!1})}},{key:"remove",value:function(){return this.manager.deleteRequestDB("/entry/"+this.id).then(b,c)}},{key:"rename",value:function(a,c){var d=this.flavors[a],e=d[d.length-1];return d[d.length-1]=c,this.save().then(b,function(){return d[d.length-1]=e,!1})}},{key:"toggleFlavor",value:function(a,b){var c=this;if(this.flavors[a]){var d=function(){if(1===c.flavorNumber)return{v:Promise.resolve({state:"err-one"})};var b=c.flavors[a];return delete c.flavors[a],{v:c.save().then(function(){return{state:"removed"}},function(){return c.flavors[a]=b,!1})}}();if("object"===("undefined"==typeof d?"undefined":_typeof(d)))return d.v}else{var e=function(){var d=c.flavors[b][c.flavors[b].length-1];return c.flavors[a]=[d],{v:c.save().then(function(){return{state:"added",name:d}},function(){return delete c.flavors[a],!1})}}();if("object"===("undefined"==typeof e?"undefined":_typeof(e)))return e.v}}},{key:"addGroup",value:function(a){var d=this;return this.manager.putRequestDB("/entry/"+this.id+"/_owner/"+a).then(function(){return d.reload()}).then(b,c)}},{key:"removeGroup",value:function(a){var d=this;return this.manager.deleteRequestDB("/entry/"+this.id+"/_owner/"+a).then(function(){return d.reload()}).then(b,c)}},{key:"reload",value:function(){var a=this;return this.manager.getRequestDB("/entry/"+this.id).then(function(b){return a.view=b.body})}},{key:"togglePublic",value:function(){return-1===this.view.$owners.indexOf(d)?this.addGroup(d):this.removeGroup(d)}},{key:"content",get:function(){return this.view.$content}},{key:"creationDate",get:function(){return new Date(this.view.$creationDate)}},{key:"flavors",get:function(){return this.content.flavors}},{key:"flavorNumber",get:function(){return Object.keys(this.content.flavors).length}},{key:"id",get:function(){return this.view._id}},{key:"modificationDate",get:function(){return new Date(this.view.$modificationDate)}},{key:"owner",get:function(){return this.view.$owners[0]}},{key:"owners",get:function(){return this.view.$owners.slice(1).filter(a.isEmail)}},{key:"revid",get:function(){return this.view._rev}},{key:"size",get:function(){var a=0,b=this.view._attachments;if(b)for(var c in b)a+=b[c].length||.75*b[c].data.length;return a}},{key:"title",get:function(){return this.content.title||""}},{key:"version",get:function(){return this.content.version||"0.0.0"}},{key:"public",get:function(){return-1!==this.view.$owners.indexOf(d)}}]),e}();return e});