"use strict";define(["src/util/util","src/util/debug","src/util/ui","lodash","jquery","slickgrid","mime-types"],function(a,b,c,d,e,f,g){function h(a,b){for(var c=new Array(a.length),d=0;d<a.length;d++){var e=a[d];c[d]={name:e.name,contentType:e.content_type,size:e.length,toDelete:!1},b.docUrl&&(c[d].downloadUrl=b.docUrl+"/"+e.name)}return c}function i(a,b){var h=b.mode;a&&h&&k[h]&&(a=k[h](a,b));var i=new f.Data.DataView;return a=a||[],i.setItems(a,"name"),m.then(function(){return new Promise(function(b){function h(b,c){c=c||"";var e=n+(""===c?b.name:c+"/"+b.name),f=d.find(a,function(a){return a.name===e});f?(f.file=b,f.color="orange"):a.push({name:e,file:b,contentType:b.type||g.lookup(e)||"application/octet-stream",size:b.size||0,toDelete:!1,color:"green"})}function i(a,b){return new Promise(function(c){a.file(function(a){h(a,b),c(a)})})}function k(a,b){return b=b||"",a.isDirectory?Promise.resolve().then(function(){var c=a.createReader();return new Promise(function(a,d){c.readEntries(function(c){for(var d=[],e=0;e<c.length;e++){var f=c[e];f.isFile?d.push(i(f,b)):f.isDirectory&&d.push(k(f,b+"/"+f.name))}return a(Promise.all(d))})})}):i(a)}var l={editable:!0,enableAddRow:!1,enableCellNavigation:!0,autoEdit:!0,enableTextSelectionOnCells:!0,enableColumnReorder:!0,forceFitColumns:!0,multiColumnSort:!0,asyncEditorLoading:!0,asyncEditorLoadDelay:30,enableAsyncPostRender:!0,asyncPostRenderDelay:0,rowHeight:20},m=[{id:"name",name:"name",field:"name",sortable:!1},{id:"contentType",name:"contentType",field:"contentType",editor:f.Editors.Text,sortable:!1},{id:"size",name:"size",field:"size",sortable:!1},{id:"toDelete",name:"toDelete",field:"toDelete",width:40,editor:f.Editors.Checkbox,formatter:f.Formatters.Checkmark}];a[0]&&a[0].downloadUrl&&m.push({id:"__download_attachment__",name:"Download",field:"__download_attachment__",sortable:!1,width:30,formatter:j});var o=e('<div class="upload-ui">'),p=e('<div class="dropzone">'),q=e('<input type="checkbox">Select/Unselect Delete</input>');q.on("change",function(){var b=!!this.checked;a.forEach(function(a){"view.json"===a.name&&"data.json"!==a.name&&"meta.json"!==a.name||(a.toDelete=b)}),r.invalidate(),r.render()});var r;c.dialog(o,{buttons:{Cancel:function(){e(this).dialog("close")},Upload:function(){var c=d.filter(a,function(a){return a.file||a.toDelete});b(c),e(this).dialog("close")}},close:function(){b(!1)},resize:function(){r.resizeCanvas()},open:function(){o.append(p),o.append(q),r=new f.Grid(p,a,m,l)},closeOnEscape:!0,width:700,height:500});var s=0;o[0].addEventListener("dragenter",function(a){a.preventDefault(),a.stopPropagation(),s++,1===s&&p.addClass("drop-over")}),o[0].addEventListener("dragleave",function(a){a.preventDefault(),a.stopPropagation(),s--,s||p.removeClass("drop-over")}),o[0].addEventListener("dragover",function(a){a.preventDefault()}),o[0].addEventListener("drop",function(a){a.stopPropagation(),a.preventDefault(),s=0,o.removeClass("drop-over");for(var b=[],c=0;c<a.dataTransfer.items.length;c++){var d=a.dataTransfer.items[c].webkitGetAsEntry();b.push(k(d,d.name))}Promise.all(b).then(function(){r.updateRowCount(),r.render(),r.autosizeColumns()})})})})}function j(a,b,c,d,e){var f=e.name.replace(/^.*\//,"");return'<div style="width:100%; height: 100%;"><a href="'+e.downloadUrl+'" download="'+f+'" class="download-attachment"><i class="centered-icon fa fa-download"></i></a></div>'}var k={couchdb:h,couch:h},l={},m=Promise.all([a.loadCss("components/slickgrid/slick.grid.css"),a.loadCss("src/util/uploadUi.css")]),n="upload/";return l.uploadDialog=i,l});