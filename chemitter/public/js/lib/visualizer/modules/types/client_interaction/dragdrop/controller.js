"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a};define(["modules/default/defaultcontroller","src/util/api","src/util/versioning","src/data/structures","src/util/debug","src/util/util","src/util/ui","src/util/mimeTypes"],function(a,b,c,d,e,f,g,h){function i(){}function j(a){for(var b=[],c=function(c){var d=a[c];b.push({kind:d.kind,type:"text/plain"===d.type?"auto":d.type,str:new Promise(function(a){d.getAsString(a)}),id:c})},d=0;d<a.length;d++)c(d);return b}function k(a){return function(b){return h.lookup(b)||a}}function l(a){for(var b="",c=0;c<a.length;c++){var d=a[c];b+="mime"===d.filter?"Mime: ":"Extension: ",b+=d.extension+"<br>"}return b+="<br><br>"}return $.extend(!0,i.prototype,a),i.prototype.moduleInformation={name:"Drag and drop",description:"Drop a file or paste some content to load",author:"Norman Pellet, MichaÃ«l Zasso",date:"31.07.2014",license:"MIT",cssClass:"dragdrop"},i.prototype.references={data:{label:"First data element"},dataarray:{label:"Array of loaded data"}},i.prototype.events={onRead:{label:"The data has been read",refVariable:["data","dataarray"]}},i.prototype.configurationStructure=function(){var a=f.getStructuresComboOptions();return{groups:{group:{options:{type:"list"},fields:{label:{type:"text",title:"Text displayed by default",default:"Drop your file here"},dragoverlabel:{type:"text",title:"Text displayed on drag"},hoverlabel:{type:"text",title:"Text displayed on hover"},getusermedia:{type:"checkbox",title:"Use getUserMedia",options:{yes:"Yes"},default:[]},capture:{type:"combo",title:"Capture",options:[{title:"none",key:"none"},{title:"camera",key:"camera"},{title:"camcorder",key:"camcorder"},{title:"microphone",key:"microphone"}],default:"none"}}},vars:{options:{type:"table",multiple:!0,title:"For files"},fields:{filter:{type:"combo",title:"filter on",options:[{title:"File extension",key:"ext"},{title:"Mime-type",key:"mime"}],default:"ext"},extension:{type:"text",title:"Filter",default:"*"},filetype:{type:"combo",title:"Read type",options:[{title:"Text",key:"text"},{title:"Base64 Encoded",key:"base64"},{title:"Object URL",key:"url"},{title:"Array buffer",key:"buffer"}],default:"text"},type:{type:"combo",title:"Force type",options:a,default:""},mime:{type:"text",title:"Force mime-type"},variable:{type:"text",title:"Temporary variable",default:"file"}}},string_general:{options:{type:"list",title:"For strings (general)"},fields:{askFilename:{type:"checkbox",title:"Ask for filename",options:{yes:"Yes"},default:[]}}},string:{options:{type:"table",multiple:!0,title:"For strings"},fields:{filter:{type:"combo",title:"filter on",options:[{title:"File extension",key:"ext"},{title:"Mime-type",key:"mime"}],default:"ext"},extension:{type:"text",title:"Filter",default:"*"},type:{type:"combo",title:"Force type",options:a,default:""},mime:{type:"text",title:"Force mime-type"},variable:{type:"text",title:"Temporary variable",default:"str"}}},photo:{options:{type:"table",multiple:!1,title:"For photos"},fields:{variable:{type:"text",title:"Temporary variable",default:"photo"}}}}}},i.prototype.configAliases={vartype:["groups","group",0,"vartype",0],label:["groups","group",0,"label",0],dragoverlabel:["groups","group",0,"dragoverlabel",0],hoverlabel:["groups","group",0,"hoverlabel",0],getusermedia:["groups","group",0,"getusermedia",0],vars:["groups","vars",0],string:["groups","string",0],photo:["groups","photo",0],showPhotoButton:["groups","group",0,"showPhotoButton",0],capture:["groups","group",0,"capture",0],askFilename:["groups","string_general",0,"askFilename",0]},i.prototype.initImpl=function(){var a,b,c,d,e=this.module.getConfiguration("vars");if(e){var f=[];for(a=0,b=e.length;b>a;a++)c=e[a],d=$.extend({},c),f.push(d),c.extension?d.match=new RegExp("^"+c.extension.replace(/\*/g,".*").replace(/\?/g,".")+"$","i"):d.match=/^.*$/i,c.filter||(d.filter="ext");this.fileCfg=f}var g=this.module.getConfiguration("string");if(g){var h=[];for(a=0,b=g.length;b>a;a++)c=g[a],d=$.extend({},c),h.push(d),c.filter?d.match=new RegExp("^"+c.extension.replace(/\*/g,".*").replace(/\?/g,".")+"$","i"):d.match=/^text\/plain$/i,d.filetype="text";this.stringCfg=h,this.photoCfg=this.module.getConfiguration("photo")}this.resolveReady()},i.prototype.parseString=function(a,b){try{if(b.cfg.type)var c=d._parse(b.cfg.type,a);else c=a;this.tmpVar(c,b)}catch(b){e.info("Value could not be parsed: ",a,b)}},i.prototype.open=function(a){if(a.items&&a.items.length||a.files.length){for(var b,c=!0,d=0;d<a.items.length;d++)"string"!==a.items[d].kind&&(c=!1);1===a.items.length&&(c=!1),b=c?j(a.items):a.items,this.module.model.tmpVars=new DataObject,this.module.model.tmpVarsArray=new DataObject;var e,f,g,h,i=this,l=[],m=this.fileCfg,n=this.stringCfg;if(b)if(c){var g={};g.cfg=n,g.def=$.Deferred(),l.push(g.def),this.treatMultipleString(b,g)}else for(e=0;e<b.length;e++)f=b[e],h=$.Deferred(),l.push(h),"file"===f.kind?(f=f.getAsFile(),(g=this.checkMetadata(f,m,k("application/octet-stream")))?(g.def=h,this.read(f,g)):h.resolve()):(g={},g.cfg=n,g.def=h,this.treatString(f,g));else for(e=0;e<a.files.length;e++)f=a.files[e],h=$.Deferred(),l.push(h),(g=this.checkMetadata(f,m,k("application/octet-stream")))?(g.def=h,this.read(f,g)):h.resolve();$.when.apply(window,l).done(function(){i.createDataFromEvent("onRead","data",i.module.model.tmpVars),i.createDataFromEvent("onRead","dataarray",i.module.model.tmpVarsArray)})}},i.prototype.openPhoto=function(a){var b=this,c=this.checkPhotoMetadata(this.photoCfg);c.def=$.Deferred(),this.fileRead(a,c),c.def.done(function(){b.createDataFromEvent("onRead","data",b.module.model.tmpVars),b.createDataFromEvent("onRead","dataarray",b.module.model.tmpVarsArray)})},i.prototype.treatMultipleString=function(a,b){var c=this;g.choose(a,{noConfirmation:!0,returnRow:!0,idField:"id",columns:[{id:"key",name:"content-type",field:"type"}]}).then(function(a){return"auto"===a.type&&(a.type=""),void 0===a?void b.def.resolve():(a.getAsString=function(b){a.str.then(b)},void c.treatString(a,b))})},i.prototype.treatString=function(a,b){var c=this,d=this,e=l(b.cfg);a.getAsString(function(f){if(c.module.getConfigurationCheckbox("askFilename","yes"))g.enterValue({description:e,label:"Enter filename",validationMessage:"Incorrect file extension",validation:function(d){return c.checkMetadata(a,b.cfg,k("text/plain"),d)}}).then(function(e){if(void 0!==e){var g=c.checkMetadata(a,b.cfg,k("text/plain"),e);if(!g)return void b.def.resolve();Object.assign(b,g),d.parseString(f,b)}});else{var h=c.checkMetadata(a,b.cfg,k("text/plain"));if(!h)return void b.def.resolve();Object.assign(b,h),d.parseString(f,b)}})},i.prototype.checkMetadata=function(a,b,c,d){if(!b)return e.warn("No file filter configured");d=d||a.name||"";var f,h,i=a.type||c(d),j=d.split(".");f=j.length<2?"":j.pop().toLowerCase();for(var k=0,l=b.length;l>k;k++){var m=b[k].filter;if("ext"===m){var n=b[k].extension;if("*"===n||-1!==n.split(",").indexOf(f)){h=b[k];break}}else{var o=b[k].match;if(o.test(i)){h=b[k];break}}}if(!h){var p="Did not find match for "+d+" ("+i+")";return g.showNotification(p,"warn"),e.warn(p)}return{filename:d,mime:h.mime||i||"application/octet-stream",cfg:h}},i.prototype.checkPhotoMetadata=function(a){var b=a[0];return b.filetype="url",b.type="png",{mime:"image/png",cfg:b}},i.prototype.fileRead=function(a,b){switch(b.cfg.filetype){case"text":this.parseString(a,b);break;case"base64":var c=a.indexOf(";base64,");this.tmpVar(a.substr(c+8),b);break;case"url":case"buffer":this.tmpVar(a,b)}},i.prototype.read=function(a,b){var c=this,d=new FileReader;switch(d.onload=function(a){c.fileRead(a.target.result,b)},d.onerror=function(a){e.error(a)},b.cfg.filetype){case"text":d.readAsText(a);break;case"base64":case"url":d.readAsDataURL(a);break;case"buffer":d.readAsArrayBuffer(a)}},i.prototype.tmpVar=function(a,b){"object"!==("undefined"==typeof a?"undefined":_typeof(a))&&b.cfg.type&&(a={type:b.cfg.type,value:a});var c=b.cfg.variable,d=new DataObject({encoding:b.cfg.filetype,filename:b.filename,mimetype:b.mime,contentType:b.mime,content:a});this.module.model.tmpVarsArray[c]||(this.module.model.tmpVarsArray[c]=new DataArray),this.module.model.tmpVarsArray[c].push(d),this.module.model.tmpVars[c]=d,b.def.resolve()},i.prototype.emulDataTransfer=function(a){var b={};b.files=a.target.files,b.items=[];for(var c=0;c<a.target.files.length;c++)!function(c){b.items.push({kind:"file",getAsFile:function(){return a.target.files[c]}})}(c);return b},i});