"use strict";define(["modules/default/defaultview","src/util/debug","lodash","src/util/util","src/util/api","src/util/typerenderer","slickgrid","src/util/sandbox","src/data/structures"],function(a,b,c,d,e,f,g,h,i){function j(){}function k(a){a.$container.html("");var d=a.getAllSlickColumns().filter(p),f=c.map(d,"id");for(var h in u)-1===f.indexOf(h)&&delete u[h];if(a.hiddenColumns||(a.hiddenColumns=d.map(function(a){return a.colDef&&a.colDef.hideColumn&&"yes"===a.colDef.hideColumn[0]?a.name:void 0}).filter(function(a){return a})),a.slick.columns=a.getInMainColumns(),a.$rowToolbar=$("<div>").attr("class","rowToolbar"),a.module.getConfigurationCheckbox("toolbar","add")&&(a.$addButton=$('<input type="button" value="New"/>'),a.$addButton.on("click",function(){var b=a.grid.getColumns(),d=c.findIndex(b,function(a){return a.editor});d>-1&&(a.preventRowHelp(),a.grid.gotoCell(a.slick.data.getLength(),d,!0)),a._openDetails()}),a.$rowToolbar.append(a.$addButton)),a.module.getConfigurationCheckbox("toolbar","update")&&(a.$updateButton=$('<input type="button" value="Update"/>'),a.$updateButton.on("click",function(){a._openDetails()}),a.$rowToolbar.append(a.$updateButton)),a.module.getConfigurationCheckbox("toolbar","remove")&&(a.$deleteButton=$('<input type="button" value="Delete"/>'),a.$deleteButton.on("click",function(){a.deleteRowSelection()}),a.$rowToolbar.append(a.$deleteButton)),a.module.getConfigurationCheckbox("toolbar","showHide")){a.$showHideSelection=$.tmpl('<input type="button" value="Show/Hide Column"/>\n    <div class="mutliSelect" style="display:none">\n        <ul>\n            {{each columns}}\n            \n            <li><input type="checkbox" value="${name}" checked/>${name}</li>\n            {{/each}}\n        </ul>\n    </div>',{columns:d}),a.columnSelectionShown&&a.$showHideSelection.filter("div").show(),a.$showHideSelection.on("click",function(){a.$showHideSelection.filter("div").toggle(),a.columnSelectionShown=a.$showHideSelection.filter("div").is(":visible"),a.onResize()});for(var i=0;i<a.hiddenColumns.length;i++)a.$showHideSelection.find('input[value="'+a.hiddenColumns[i]+'"]').removeAttr("checked");a.$showHideSelection.find('input[type="checkbox"]').on("change",function(){return this.checked?a.hideColumn(this.value):a.showColumn(this.value),a.$container.html(""),k(a)}),a.$rowToolbar.append(a.$showHideSelection)}a.$actionButtons=new Array(a.actionOutButtons.length);for(var i=0;i<a.actionOutButtons.length;i++)!function(b){a.$actionButtons[b]=$('<input type="button" value="'+a.actionOutButtons[b].buttonTitle+'"/>'),a.$actionButtons[b].on("click",function(){a.module.controller.sendActionButton(a.actionOutButtons[b].actionName,a._getSelectedItems())})}(i);a.$rowToolbar.append(a.$actionButtons),a.$container.append(a.$rowToolbar),a.module.getConfiguration("toolbar")&&0===a.module.getConfiguration("toolbar").length&&a.$actionButtons&&0===a.$actionButtons.length&&a.$rowToolbar&&a.$rowToolbar.remove(),a.$slickgrid=$("<div>").addClass("flex-1"),a.$container.append(a.$slickgrid),a.slick.groupItemMetadataProvider=new g.Data.GroupItemMetadataProvider,a.slick.plugins.push(a.slick.groupItemMetadataProvider),a.slick.data=new g.Data.DataView({groupItemMetadataProvider:a.slick.groupItemMetadataProvider}),a.slick.data.setModule(a.module),a.grid=new g.Grid(a.$slickgrid,a.slick.data,a.slick.columns,a.slick.options),a.slick.grid=a.grid,a._newSandbox();for(var i=0;i<a.slick.plugins.length;i++)a.grid.registerPlugin(a.slick.plugins[i]);if("row"===a.module.getConfiguration("slick.selectionModel")?a.grid.setSelectionModel(new g.RowSelectionModel):a.grid.setSelectionModel(new g.CellSelectionModel),a.module.getConfigurationCheckbox("autoColumns","reorder")){var j=new g.RowMoveManager({cancelEditOnDrag:!0});j.onBeforeMoveRows.subscribe(function(a,b){for(var c=0;c<b.rows.length;c++)if(b.rows[c]==b.insertBefore||b.rows[c]==b.insertBefore-1)return a.stopPropagation(),!1;return!0}),j.onMoveRows.subscribe(function(b,c){var d=c.rows;d=d.map(function(b){return a._getItemInfoFromRow(b).idx});var e=a._getItemInfoFromRow(c.insertBefore);null!==e&&(e=e.idx),a._makeDataObjects();for(var f=a.slick.data.getItems(),g=0;g<f.length;g++)-1!==d.indexOf(g)?f[g].__pos=2:e>g||null===e?f[g].__pos=1:f[g].__pos=3;a.slick.data.sort(q);for(var g=0;g<f.length;g++)delete f[g].__pos;a.grid.invalidateAllRows(),a.grid.render(),a.module.model.dataTriggerChange(a.module.data)}),a.grid.registerPlugin(j),a.grid.onDragInit.subscribe(function(a,b){a.stopImmediatePropagation()}),a.grid.onDragStart.subscribe(function(b,c){var d=this.module.data.get(),e=a.grid.getCellFromEvent(b);if(e&&(c.row=e.row,d[c.row]&&!g.GlobalEditorLock.isActive())){b.stopImmediatePropagation(),c.mode="recycle";var f=a.grid.getSelectedRows();f.length&&-1!=$.inArray(c.row,f)||(f=[c.row],a.grid.setSelectedRows(f)),c.rows=f,c.count=f.length;var h=$("<span></span>").css({position:"absolute",display:"inline-block",padding:"4px 10px",background:"#e0e0e0",border:"1px solid gray","z-index":99999,"-moz-border-radius":"8px","-moz-box-shadow":"2px 2px 6px silver"}).appendTo("body");return c.helper=h,$(c.available).css("background","pink"),h}}),a.grid.onDrag.subscribe(function(a,b){"recycle"==b.mode&&b.helper.css({top:a.pageY+5,left:a.pageX+5})}),a.grid.onDragEnd.subscribe(function(a,b){"recycle"==b.mode&&(b.helper.remove(),$(b.available).css("background","beige"))})}$(a.grid.getHeaderRow()).delegate(":input","change keyup",c.debounce(function(b){var c=$(this).data("columnId");null!=c&&(u[c]=$.trim($(this).val()),v[c]=o(u[c]),a.slick.data.refresh())},250)),a.grid.onHeaderRowCellRendered.subscribe(function(a,b){$(b.node).empty(),$("<input type='text'>").css("width","100%").data("columnId",b.column.id).val(u[b.column.id]).appendTo(b.node)}),a.grid.init(),a._activateHighlights(),a.grid.module=a.module,a.slick.data.syncGridSelection(a.grid,!0),a.module.getConfigurationCheckbox("slickCheck","oneUncollapsed")&&a.slick.groupItemMetadataProvider.onGroupExpanded.subscribe(function(a,b){this.getData().collapseAllGroups(b.item.level),this.getData().expandGroup(b.item.groupingKey)}),a.slick.data.onRowCountChanged.subscribe(function(b,c){a.grid.updateRowCount(),a.grid.render()}),a.slick.data.onRowsChanged.subscribe(function(b,c){if(a.hasFilter){var d=a._getItemsInfo(c.rows);a._runFilter({event:"rowsChanged",rows:d})}a.grid.invalidateRows(c.rows),a.grid.render()}),a.grid.onAddNewRow.subscribe(function(b,c){var d=a.module.data.get(),e=d[d.length-1];a._newRow(e,c)}),a.grid.onRenderCompleted.subscribe(function(){a._jpathColor()}),a.grid.onViewportChanged.subscribe(function(){function b(){if(a.lastViewport=a.grid.getViewport(),a.module.getConfigurationCheckbox("slickCheck","rowNumbering")&&!a._preventRowHelp){var b=a.grid.getDataLength();a.$rowHelp.html(Math.min(b,a.lastViewport.bottom-(a.addRowAllowed?2:1)).toString()+"/"+b),a.$rowHelp.fadeIn(),clearTimeout(a.lastRowHelp),a.lastRowHelp=setTimeout(function(){a.$rowHelp.fadeOut()},1e3)}a._preventRowHelp=!1,a._jpathColor(),a._inViewFilter()}setTimeout(function(){var c=a.grid.getViewport();c!==a.lastViewport&&b()},250),b()}),a.grid.onMouseEnter.subscribe(function(b){a._hl&&e.highlightId(a._hl,0),a.count=void 0===a.count?0:a.count,a.count++,a.hovering=!0;var c=a._getItemInfoFromEvent(b);if(c){var d=c.item._highlight;a._hl=d,d&&(e.highlightId(d,1),A=d),a.module.controller.onHover(c.idx,c.item)}}),a.grid.onMouseLeave.subscribe(function(b){a._e=b,a.count--,a.hovering=!1;var c=a._getItemInfoFromEvent(b);if(c){var d=c.item._highlight;d?e.highlightId(d,0):A&&e.highlightId(A,0)}}),a.grid.onColumnsResized.subscribe(function(){for(var b=a.grid.getColumns(),c=0;c<b.length;c++){var d=a.colConfig.find(function(a){return a===b[c].colDef});d&&(d.width=b[c].width)}a.grid.invalidate()}),a.grid.onCellChange.subscribe(function(b,c){if(a.fromPopup)var d=a.getColumnsGivenEditContext();else var e=a._getChangedColumn(c.cell);var f=a._getItemInfoFromRow(c.row);if(f){if(a.hasFilter){if(d)for(var g=0;g<d.length;g++)a._runFilter({event:"cellChanged",row:f,cell:a._getCell({row:c.row,cell:g}),column:d[g]});else a._runFilter({event:"cellChanged",row:f,cell:a._getCell(c),column:e});a._runFilter({event:"rowsChanged",rows:[f]})}a.module.controller.onRowChange(f.idx,f.item)}}),a.grid.onClick.subscribe(function(b,c){var d=a.grid.getColumns(),e=a._getItemInfoFromRow(c.row);e&&d[c.cell]&&"rowDeletion"!==d[c.cell].id&&(d[c.cell].colDef&&d[c.cell].colDef.isAction||a.module.controller.onClick(e.idx,e.item))}),a.grid.onActiveCellChanged.subscribe(function(b,c){a.lastActiveCell=c.cell,a.lastActiveRow=c.row;var d=a.grid.getColumns(),e=a._getItemInfoFromRow(c.row);e&&d[c.cell]&&"rowDeletion"!==d[c.cell].id&&a.module.controller.onActive(e.idx,e.item)}),a.grid.onColumnsReordered.subscribe(function(){var d=a.grid.getColumns(),e=a.module.definition.configuration.groups.cols[0],f=c.map(e,"name"),g=c.map(d,"id");if(f.concat().sort().join()!==g.concat().sort().join())return void b.warn("Something might be wrong, number of columns in grid and in configuration do not match");a.module.definition.configuration.groups.cols[0]=[];for(var h=0;h<d.length;h++){var i=f.indexOf(g[h]);i>-1&&a.module.definition.configuration.groups.cols[0].push(e[i])}}),a.grid.onSelectedRowsChanged.subscribe(function(b,d){a.lastSelectedRows=d.rows;var e=a._getItemsInfo(d.rows);a.hasFilter&&a._runFilter({event:"rowsSelected",rows:e}),a.module.controller.onRowsSelected(c.map(e,"item"))}),a.grid.onSort.subscribe(function(b,c){a._makeDataObjects();var d;d=c.sortCols?c.sortCols:[{sortCol:c.sortCol,sortAsc:c.sortAsc}];for(var e=function(b){g=function(a,c){return void 0===a?d[b].sortAsc?1:-1:void 0===c?d[b].sortAsc?-1:1:c>a?-1:a>c?1:0};var c=d[b],e=c.sortCol.jpath;a.slick.data.sort(g,c.sortAsc,function(a){var b=a.getChildSync(e);return void 0!==b&&(b=b.get()),b})},f=d.length-1;f>=0;f--){var g;e(f)}a._updateHighlights(),a.grid.invalidateAllRows(),a.grid.render(),a.module.model.dataTriggerChange(this.module.data)}),a.slick.data.beginUpdate();var l=c.chain(a.module.getConfiguration("groupings")).filter(function(a){return a&&a.groupName&&a.getter}).map(function(b){var c={};return b.getter&&b.getter.length>1?(c.getter=function(a){return a.getChildSync(b.getter)},a._makeDataObjects()):c.getter=b.getter[0],c.formatter=function(a){return b.groupName+": "+a.value+"  <span style='color:green'>("+a.count+" items)</span>"},c.aggregateCollapsed=!1,c.lazyTotalsCalculation=!0,c}).value();l.length&&(a.slick.data.setGrouping(l),a.module.getConfigurationCheckbox("slickCheck","collapseGroup")&&a.slick.data.collapseAllGroups(0)),a.module.getConfigurationCheckbox("slickCheck","filterColumns")&&a.slick.data.setFilter(s),a.slick.data.setItems(a.module.data.get(),a.idPropertyName),a.slick.data.endUpdate(),a.lastViewport&&!a.module.getConfigurationCheckbox("slickCheck","backToTop")&&a.grid.scrollRowToTop(a.lastViewport.top),Array.isArray(a.lastSelectedRows)&&a.grid.setSelectedRows(a.lastSelectedRows),c.isUndefined(a.lastActiveRow)||a.module.getConfigurationCheckbox("slickCheck","forgetLastActive")||a.grid.gotoCell(a.lastActiveRow,a.lastActiveCell,!1,!0),a.grid.render(),a._setBaseCellCssStyle(),a.lastViewport=a.grid.getViewport(),a._jpathColor(),a._inViewFilter()}function l(){return"..."}function m(){return'<div style="width:100%; height: 100%;"><a class="recycle-bin"><i class="centered-icon fa fa-trash"></i></a></div>'}function n(a,b,c,d){if(!c.__group&&(this.module.data.traceSync([b]),a)){var e=d.rendererOptions||{};d.renderType&&(e.forceType=d.renderType),f.render(a,c,d.jpath,e)}}function o(a){var b;if(b=a.match(/^"(.*)"$/))return function(a){return b=b.toLowerCase(),a=a.toString().toLowerCase(),a.match(b[1])};if(b=a.match(/^\/(.*)\/(i?)/))return function(a){return a.toString().match(new RegExp(b[1],b[2]||void 0))};if(b=a.match(/^([<>=]{1,2})([0-9.]+)$/)){if("<"===b[1])return function(a){return a<b[2]};if("<="===b[1]||"=<"===b[1])return function(a){return a<=b[2]};if(">"===b[1])return function(a){return a>b[2]};if(">="===b[1]||"=>"===b[1])return function(a){return a>=b[2]};if("=="===b[1]||"="===b[1])return function(a){return a==b[2]}}return b=a.match(/^([0-9.]+)\.\.([0-9.]*)$/),b?function(a){return a>=b[1]&&a<=b[2]}:function(b){return b.toString().toLowerCase().match(a.toLowerCase())}}function p(a){return"rowDeletion"!==a.id&&"_checkbox_selector"!==a.id&&"__selectAndMove"!==a.id}function q(a,b){return a.__pos-b.__pos}var r=[];r.push(d.loadCss("components/slickgrid/slick.grid.css"));var s,t=Promise.all(r),u={},v={},w=0,x={typerenderer:l,"slick.text":g.Formatters.Text,"slick.percent":g.Formatters.PercentComplete,"slick.percentbar":g.Formatters.PercentCompleteBar,"slick.yesno":g.Formatters.YesNoSelect},y={};for(var z in i)"string"==typeof i[z]&&(y[z]=y[i[z]]);y.string=g.CustomEditors.TextValue,y.number=g.CustomEditors.NumberValue,y.boolean=g.CustomEditors.BooleanValue,y.color=g.CustomEditors.ColorValue,y.date=g.CustomEditors.Date,y.longtext=g.CustomEditors.LongText,$.extend(!0,j.prototype,a,{init:function(){var a=this;this._setScript(""),this.title=String(this.module.definition.title),this.$container||(this._id=d.getNextUniqueId(),this.$rowHelp=$("<div>").attr("class","rowHelp"),this.$container=$("<div>").attr("id",this._id).addClass("main-container"),this.module.getDomContent().html(this.$rowHelp),this.module.getDomContent().append(this.$container),this._setDeleteRowListener()),this.actionOutButtons=this.module.getConfiguration("actionOutButtons"),this.actionOutButtons=this.actionOutButtons||[],this.actionOutButtons=c.filter(this.actionOutButtons,function(a){return a.actionName&&a.buttonTitle}),this.$container.on("mouseleave",function(){a.module.controller.lastHoveredItemId=null}),this.hiddenColumns=void 0,this.slick={},this.colConfig=(this.module.getConfiguration("cols")||[]).filter(function(a){return a.name}),this.actionColConfig=(this.module.getConfiguration("actionCols")||[]).filter(function(a){return a.name}).map(function(a){return a.isAction=!0,a}),this.idPropertyName="_sgid","pref"===this.module.getConfiguration("filterType")&&this._setScript(this.module.getConfiguration("filterRow")),this.actionRenderer=function(b,c,d,f){if(b){var g={event:"renderAction",column:f,row:{item:d},renderOptions:{icon:f.colDef.icon,disabled:!1,action:f.colDef.action,tooltip:f.colDef.tooltip,backgroundColor:f.colDef.backgroundColor,color:f.colDef.color}};a._runFilter(g),g.renderOptions.disabled?b.innerHTML="":g.renderOptions.icon.startsWith("fa-")?b.innerHTML='<div style="width:100%; height: 100%"><a><i class="fa '+g.renderOptions.icon+' centered-icon"></i></a></div>':b.innerHTML='<div style="width:100%; height: 100%"><a>'+g.renderOptions.icon+"</a></div>";var h=$(b);h.css("backgroundColor",g.renderOptions.backgroundColor),h.find("a").css("color",g.renderOptions.color);var i=h.find("a");i.attr("title",g.renderOptions.tooltip),g.renderOptions.action&&(i.addClass("icon-clickable"),i.length&&(i[0].onclick=function(){e.doAction(g.renderOptions.action,d)}))}},this.resolveReady()},preventRowHelp:function(){this._preventRowHelp=!0},deleteRowSelection:function(){for(var a=this.grid.getSelectedRows(),b=this.module.data.get(),c=new Array(a.length),d=0;d<a.length;d++){var e=this._getItemInfoFromRow(a[d]);c[d]=e.idx}c=c.sort();var f=0,g=[];for(d=0;d<a.length;d++){var h=b.splice(c[d]-f++,1);h.length&&g.push(h[0])}this.lastSelectedRows=[],this.module.controller.onRowsDelete(g),this.module.data.triggerChange()},getAllSlickColumns:function(){function a(a){var b,c=f.module.data.get(0).getChildSync(a);return b=c instanceof DataString?g.CustomEditors.TextValue:c instanceof DataNumber?g.CustomEditors.NumberValue:c instanceof DataBoolean?g.CustomEditors.BooleanValue:y[e(a)]}function e(a){var b,c=a.slice(0);c.unshift(0);var d=f.module.data.getChildSync(c);return d instanceof DataObject&&(b=d.type),b}var f=this,h=$.proxy(n,this),i=this.colConfig.filter(function(a){return a.name}).map(function(c){var i,j;"auto"===c.editor&&f.module.data?f.module.data.get().length?(i=c.forceType?y[c.forceType]:a(c.jpath),j=e(c.jpath)):(i=g.CustomEditors.DataString,b.warn("Slick grid: using editor based on type when the input variable is empty. Cannot determine type")):(i=y[c.editor],j=e(c.jpath));var k=d.evalOptions(c.rendererOptions);return{id:c.name,name:c.name,field:c.name,width:+c.width||void 0,minWidth:+c.minWidth||void 0,maxWidth:+c.maxWidth||void 0,resizable:!0,selectable:!0,focusable:!0,sortable:!0,defaultSortAsc:!0,editor:i,compositeEditor:i===g.CustomEditors.LongText?g.CustomEditors.SimpleLongText:void 0,formatter:x[c.formatter],asyncPostRender:"typerenderer"===c.formatter?h:void 0,jpath:c.jpath,simpleJpath:1===c.jpath.length,dataType:j,renderType:c.forceType,colDef:c,rendererOptions:k}});if(i=c.filter(i,function(a){return a.name}),c.isEmpty(i)){for(var j=[],k=f.module.data.get(),l=0;l<k.length;l++)j=c(j).push(c.keys(k[l])).flatten().uniq().value();i=c(j).filter(function(a){return"_"!==a[0]}).map(function(b){return{id:b,name:b,field:b,resisable:!0,selectable:!0,focusable:!0,sortable:!1,editor:a([b]),dataType:e([b]),jpath:[b],formatter:x.typerenderer,asyncPostRender:h}}).value()}for(var o=this.getActionColumns(),l=0;l<o.length;l++)"begin"===o[l].colDef.position?i.unshift(o[l]):i.push(o[l]);if(this.module.getConfigurationCheckbox("autoColumns","remove")&&i.unshift({id:"rowDeletion",width:30,field:"rowDeletion",selectable:!1,resizable:!1,focusable:!1,sortable:!1,formatter:m}),this.module.getConfigurationCheckbox("autoColumns","select")){var p=new g.CheckboxSelectColumn({cssClass:"slick-cell-checkboxsel"});this.slick.plugins.push(p),i.unshift(p.getColumnDefinition())}return this.module.getConfigurationCheckbox("autoColumns","reorder")&&i.unshift({id:"__selectAndMove",name:"",width:40,behavior:"selectAndMove",selectable:!1,resizable:!1,cssClass:"cell-reorder dnd",formatter:function(){return""}}),i},getSlickColumns:function(){var a=this,b=this.getAllSlickColumns();return b.filter(function(b){return-1===a.hiddenColumns.indexOf(b.name)})},getInMainColumns:function(){return this.getSlickColumns().filter(function(a){return a.colDef?!a.colDef.visibility||"main"===a.colDef.visibility||"both"===a.colDef.visibility:!0})},getInPopupColumns:function(){return this.getAllSlickColumns().filter(function(a){return a.colDef?"popup"===a.colDef.visibility||"both"===a.colDef.visibility:!1}).filter(function(a){return a.editor}).filter(p)},getActionColumns:function(){var a=this;return this.actionColConfig.map(function(b){return{id:b.name,name:b.name,width:+b.width||25,minWidth:+b.minWidth||25,maxWidth:+b.maxWidth||25,selectable:!1,resizable:!0,focusable:!1,sortable:!1,formatter:l,asyncPostRender:a.actionRenderer,colDef:b}})},getColumnsGivenEditContext:function(){return this.fromPopup?this.getInPopupColumns():this.getInMainColumns()},getSlickOptions:function(){var a=this;return{editable:a.module.getConfigurationCheckbox("slickCheck","editable"),enableAddRow:a.module.getConfigurationCheckbox("slickCheck","enableAddRow"),enableCellNavigation:a.module.getConfigurationCheckbox("slickCheck","editable"),autoEdit:a.module.getConfigurationCheckbox("slickCheck","autoEdit"),enableTextSelectionOnCells:!0,enableColumnReorder:!0,forceFitColumns:a.module.getConfigurationCheckbox("slickCheck","forceFitColumns"),multiColumnSort:!0,asyncEditorLoading:!0,asyncEditorLoadDelay:30,enableAsyncPostRender:!0,asyncPostRenderDelay:0,defaultColumnWidth:a.module.getConfiguration("slick.defaultColumnWidth")||80,dataItemColumnValueExtractor:function(a,b){return a},explicitInitialization:!0,rowHeight:a.module.getConfiguration("slick.rowHeight"),showHeaderRow:a.module.getConfigurationCheckbox("slickCheck","filterColumns"),headerRowHeight:30}},_openDetails:function(){var a=this;if(!this.grid.getEditorLock().isActive()||this.grid.getEditorLock().commitCurrentEdit()){var b=this.getInPopupColumns();if(0!==b.length){var c=$("<div class='item-details-form'></div>");c=$.tmpl("<div class='item-details-form'>\n    {{each columns}}\n    <div class='item-details-label'>\n        ${name}\n    </div>\n    <div class='item-details-editor-container' data-editorid='${id.replace(/[^a-zA-Z0-9_-]/g, \"_\")}'></div>\n    {{/each}}\n\n    <hr/>\n    <div class='item-details-form-buttons'>\n        <button data-action='save'>Save</button>\n        <button data-action='cancel'>Cancel</button>\n    </div>\n</div>",{context:this.grid.getDataItem(this.grid.getActiveCell().row),columns:b}).appendTo("body"),c.keydown(function(b){b.which==$.ui.keyCode.ENTER?(a.fromPopup=!0,a.grid.getEditController().commitCurrentEdit(),a.fromPopup=!1,b.stopPropagation(),b.preventDefault()):b.which==$.ui.keyCode.ESCAPE&&(a.fromPopup=!0,a.grid.getEditController().cancelCurrentEdit(),a.fromPopup=!1,b.stopPropagation(),b.preventDefault())}),c.find("[data-action=save]").click(function(){a.fromPopup=!0,a.grid.getEditController().commitCurrentEdit(),a.fromPopup=!1}),c.find("[data-action=cancel]").click(function(){a.fromPopup=!0,a.grid.getEditController().cancelCurrentEdit(),a.fromPopup=!1});var d=$.map(b,function(a){return c.find("[data-editorid="+a.id.replace(/[^a-zA-Z0-9_-]/g,"_")+"]")}),e=new g.CompositeEditor(b,d,{destroy:function(){c.remove()}});this.grid.editActiveCell(e)||c.remove()}}},inDom:function(){},update:{script:function(a,b){"invar"===this.module.getConfiguration("filterType")&&(this._setScript(a.get()),this._runFilter({event:"scriptChanged"})),this.rerender()},list:function(a,b){var d=this;this.module.controller.lastClickedItem=void 0,this.module.data=a,this._updateHighlights(),this.dataObjectsDone=!1,this.slick.plugins=[],this.slick.options=this.getSlickOptions(),this.generateUniqIds(),this.addRowAllowed=this.module.getConfigurationCheckbox("slickCheck","enableAddRow"),s=function(a){for(var b in u)if(void 0!==b&&""!==u[b])try{var e=d.slick.data.getIdxById(a[d.idPropertyName]),f=d.grid.getColumns()[d.grid.getColumnIndex(b)],g=c.clone(DataObject.resurrect(f.jpath));if(g.unshift(e),!d.module.data.getChildSync(g)||!v[b](d.module.data.getChildSync(g).get()))return!1}catch(a){return!0}return!0},t.then(function(){k(d)})}},blank:{list:function(a){this.$container.html("")},script:function(a){"invar"===this.module.getConfiguration("filterType")&&this._setScript("")}},_newRow:function(a,b){this.module.controller.onRowNew(this.slick.data.getLength()-1,a),this.module.model.dataTriggerChange(this.module.data),this._runFilter({row:{item:a},column:b?b.column:null,cell:null,event:"newRow"})},_setBaseCellCssStyle:function(){var a=this.grid.getColumns();this.baseCellCssStyle={};for(var b=0;b<a.length;b++)this.baseCellCssStyle[a[b].id]="highlighted-cell"},_setDeleteRowListener:function(){var a=this;this.$container.on("click","a.recycle-bin",function(b){var c=a.grid.getColumns(),d=a.grid.getCellFromEvent(b);if(a.lastViewport=a.grid.getViewport(),c[d.cell]&&"rowDeletion"===c[d.cell].id){var e=a._getItemInfoFromRow(d.row),f=a.module.data.get().splice(e.idx,1);f.length&&a.module.controller.onRowsDelete(f),a.module.data.triggerChange()}})},_getItemInfoFromEvent:function(a){var b=this,c=this.grid.getCellFromEvent(a);if(!c)return null;var d=b.slick.data.mapRowsToIds([c.row])[0];return d?{id:d,idx:b.slick.data.getIdxById(d),item:b.slick.data.getItemById(d)}:null},_getItemInfoFromRow:function(a){var b=this;if(c.isUndefined(a))return null;var d=b.slick.data.mapRowsToIds([a])[0];return d?{id:d,idx:b.slick.data.getIdxById(d),item:b.slick.data.getItemById(d)}:null},_jpathColor:function(){var a=this;if(a.lastViewport){var b=a.module.getConfiguration("colorjPath"),c=a.grid.getColumns();if(b&&b.length>0){a._makeDataObjects();for(var d=a.lastViewport.top;d<=a.lastViewport.bottom;d++){var e=a.grid.getDataItem(d);if(e&&e.__group!==!0){var f=e.getChildSync(b);if(f)for(var g=0;g<c.length;g++){var h=a.grid.getCellNode(d,g);$(h).css("background-color",f.get())}}}}}},_setScript:function(a){this.filterScript=a||"",this.hasFilter=this._hasFilter(),this._newSandbox()},_newSandbox:function(){this._sandbox=new h,this._sandbox.setContext(this._getNewContext());try{this.filter=this._sandbox.run("(function() {"+this.filterScript+"\n})","Slickgrid"+this.module.getId())}catch(a){this._reportError(a)}},_runFilter:function(a){if(this.hasFilter)try{this.filter.call(a)}catch(a){this._reportError(a)}},_getNewContext:function(){var a=this;return{getSlick:function(){return a.slick},getData:function(){return a.module.data.get()},rerender:function(b){a.rerender(b)},API:e}},rerender:function(a){this.grid&&(a?this.grid.invalidateRows(a):this.grid.invalidateAllRows(),this.grid.render())},_reportError:function(a){var c="";a&&a.stack&&(c=a.message,a=a.stack);var d="Code executor error";this.title&&(d+=" ("+this.title+")"),c&&(d+=": "+c),b.error(d),b.warn(a)},_inViewFilter:function(){var a=this;if(a.hasFilter&&a.lastViewport){var b=a._getRowsFromViewport(),c=a._getItemsInfo(b);a._runFilter({rows:c,cell:null,event:"inView"})}},_selectHighlight:function(){if(!this.hovering){var a=this,b=c.findIndex(this._highlights,function(b){return b===a._highlighted[0]||b.indexOf&&b.indexOf(a._highlighted[0])>-1});if(this.lastViewport=this.grid.getViewport(),b>-1&&this.module.getConfigurationCheckbox("slickCheck","highlightScroll")){var d=a.slick.data.getItemByIdx(b),e=a.slick.data.getRowById(d[a.idPropertyName]);if(void 0===e)return;(e<this.lastViewport.top||e>=this.lastViewport.bottom)&&this.grid.scrollRowToTop(e)}}},_updateHighlights:function(){this._highlights=c.map(this.module.data.get(),"_highlight")},_drawHighlight:function(){var a=this;this.grid.removeCellCssStyles("highlight");var b={};this._selectHighlight(),this.lastViewport=this.grid.getViewport();for(var d=this.lastViewport.top;d<=this.lastViewport.bottom;d++){var e=this._getItemInfoFromRow(d);if(e){var f=e.item;c.some(a._highlighted,function(a){var b=f._highlight;return Array.isArray(b)||(b=[b]),b.indexOf(a)>-1})&&(b[d]=a.baseCellCssStyle)}}this.grid.setCellCssStyles("highlight",b)},_activateHighlights:function(){var a=this,b=c(this.module.data.get()).map("_highlight").flatten().filter(function(a){return!c.isUndefined(a)}).value();a._highlighted=[],e.killHighlight(this.module.getId());for(var d=0;d<b.length;d++)!function(d){e.listenHighlight({_highlight:b[d]},function(b,d){Array.isArray(d)||(d=[d]),b?a._highlighted=c(a._highlighted).push(d).flatten().uniq().value():a._highlighted=c.filter(a._highlighted,function(a){return-1===d.indexOf(a)}),a._drawHighlight()},!1,a.module.getId())}(d)},_makeDataObjects:function(){if(!this.dataObjectsDone){for(var a=this.module.data.get(),b=0;b<a.length;b++)a[b]=DataObject.check(a[b]);this.dataObjectsDone=!0}},_getRowsFromViewport:function(){if(!this.lastViewport)return[];var a=this.lastViewport.bottom-this.lastViewport.top+1;if(Number.isNaN(a))return[];for(var b=new Array(a),c=0;c<b.length;c++)b[c]=this.lastViewport.top+c;return b.filter(function(a){return a>=0})},_getItemsInfo:function(a){var b=[];if(!this.slick.data)return b;for(var c=0;c<a.length;c++){var d=this._getItemInfoFromRow(a[c]);d&&b.push(d)}return b},_getItems:function(a){var b=this._getItemsInfo(a);return c.map(b,"item")},_getChangedColumn:function(a){return this.getColumnsGivenEditContext()[a]},_getCell:function(a){if(!a||void 0===a.row||void 0===a.cell)return null;var b=this._getItemInfoFromRow(a.row),c=this.getColumnsGivenEditContext()[a.cell].jpath.slice();c.unshift(b.idx);var d=this.module.data.getChildSync(c);return void 0!==d&&(d=d.get()),d},_getSelectedItems:function(){return this._getItems(this.grid.getSelectedRows())},onResize:function(){this.grid&&this.grid.resizeCanvas(),this.$rowHelp.css({bottom:0})},getNextIncrementalId:function(){return++w},generateUniqIds:function(){if(this.module.data)for(var a=this.module.data.get(),b=0;b<a.length;b++)this.setNextUniqId(a[b])},setNextUniqId:function(a,b){a[this.idPropertyName]&&!b||Object.defineProperty(a,this.idPropertyName,{value:"id_"+ ++w,writable:!1,configurable:!1,enumerable:!1})},_hasFilter:function(){return c.some(this.filterScript.split("\n"),function(a){var b=a.replace(" ","");return b?!b.match(/^\s*\/\/a/):!1})},exportToTabDelimited:function(){var a,b,c=this.grid.getColumns(),d=this.module.data.get(),e="",f=[];for(a=0;a<c.length;a++)c[a].jpath&&f.push(c[a].name||"");for(e+=f.join("	")+"\r\n",a=0;a<d.length;a++){for(f=[],b=0;b<c.length;b++){var g=c[b].jpath;if(g){g=g.slice(0),g.unshift(a);var h=this.module.data.getChildSync(g,!1);h=h?h.get():"","string"==typeof h&&(h=h.replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")),f.push(h)}}e+=f.join("	")+"\r\n"}return e},showColumn:function(a){this.hiddenColumns&&-1===this.hiddenColumns.indexOf(a)&&(this.hiddenColumns.push(a),k(this))},hideColumn:function(a){if(this.hiddenColumns){var b=this.hiddenColumns.indexOf(a);b>-1&&(this.hiddenColumns.splice(b,1),k(this))}},onActionReceive:{addRow:function(a){this.slick.data&&(a=DataObject.resurrect(a),this.setNextUniqId(a,!0),this.slick.data.addItem(a),this._newRow(a))},rerender:function(){this.grid&&(this.grid.invalidateAllRows(),this.grid.render())},hoverRow:function(a){var b,d=this.module.data.get();if(b=c.isNumber(a)||a instanceof DataNumber?d[a]:a,b&&b[this.idPropertyName]){var e=this.slick.data.getRowById(b[this.idPropertyName]),f=this.slick.data.getIdxById(b[this.idPropertyName]);this.module.controller.onHover(f,b),this.grid.scrollRowToTop(e)}},selectRow:function(a){var b,d=this.module.data.get();if(b=c.isNumber(a)||a instanceof DataNumber?d[a]:a,b&&b[this.idPropertyName]){var e=this.slick.data.getRowById(b[this.idPropertyName]),f=this.slick.data.getIdxById(b[this.idPropertyName]);this.module.controller.onClick(f,b),c.isUndefined(e)||(this.grid.scrollRowToTop(e),this.grid.setActiveCell(e,0))}},selectRows:function(a){var b;if("all"===a){b=new Array(this.slick.data.getLength());for(var c=0;c<b.length;c++)b[c]=c}else b=Array.isArray(a)?a:[];this.grid.setSelectedRows(b)},showColumn:function(a){this.showColumn(a)},hideColumn:function(a){this.hideColumn(a)}}});var A="";return j});