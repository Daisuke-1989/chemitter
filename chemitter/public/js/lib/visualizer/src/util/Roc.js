"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();define(["src/util/api","src/util/ui","src/util/util","superagent","uri/URI","lodash","src/util/couchdbAttachments","src/util/mimeTypes","src/util/IDBKeyValue"],function(a,b,c,d,e,f,g,h,i){function j(a,b,c){var d=Object.assign({},r.messages,t[b],a&&a.messages);return a=Object.assign({},r,a,c),d&&(a.messages=d),a.type=b,a}function k(a,b){return function(c){throw b.mute&&b.muteError||(c.status||c.timeout?n(c,a,b):p(c)),c}}function l(a,b){return function(c){return b.mute||b.muteSuccess||(c.status?m(c,a,b):b.type&&b.type.match(/attachment/i)&&m({status:200},a,b)),c}}function m(a,c,d){var e=d.messages[a.status]||c.messages[a.status];e&&!d.disableNotification&&b.showNotification(e,"success")}function n(a,c,d){var e=d.messages[a.status]||c.messages[a.status];e&&!d.disableNotification&&(b.showNotification(e,"error"),console.error(a,a.stack))}function o(a){var b,c=DataObject.getType(a);if("string"===c)b=a;else{if("object"!==c)throw new Error("Bad arguments");b=a._id}return String(b)}function p(a){b.showNotification("Error: "+a.message,"error"),console.error(a,a.stack)}function q(a,b){b=b||"application/octet-stream";var c=a.filename,d=a.contentType;d&&"application/octet-stream"!==d||(a.contentType=h.lookup(c,b))}var r={messages:{200:"OK",201:"Created",202:"Accepted",204:"No content",400:"Bad request",401:"Unauthorized",404:"Not Found",409:"Conflict",403:"Forbidden",408:"Request timeout",500:"Internal server error",502:"Bad gateway"}},s=["get","getAttachment","getView"],t={get:{401:"Unauthorized to get entry"},create:{200:"Entry created",201:"Entry created",401:"Unauthorized to create entry"},update:{200:"Entry updated",401:"Unauthorized to update entry",404:"Could not update entry: does not exist"},delete:{200:"Entry deleted",401:"Unauthorized to delete entry",404:"Cannot delet entry: does not exist"},addAttachment:{200:"Added attachment",401:"Unauthorized to add attachment",404:"Cannot add attachment: document does not exist"},deleteAttachment:{200:"Attachment deleted",401:"Unauthorized to delete attachment",404:"Cannot delete attachment: does not exist"},getAttachment:{401:"Unauthorized to get attachment",404:"Attachment does not exist"},getView:{401:"Unauthorized to get view",404:"View does not exist"}};for(var u in r.messages)if("300">u)for(var v=0;v<s.length;v++)t[s[v]][u]="";var w=["key","startkey","endkey"],x=["url","database"],y=function(){function h(a){_classCallCheck(this,h);for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);for(var c=0;c<x.length;c++)if(!this[x[c]])throw new Error(x[c]+" is a mandatory option");this.messages=this.messages||{},this.variables={},this.requestUrl=new e(a.url),this.databaseUrl=this.requestUrl.directory(this.requestUrl.directory()+"/db/"+this.database).normalize().href(),this.entryUrl=this.databaseUrl+"entry",this.__ready=Promise.resolve()}return _createClass(h,[{key:"view",value:function(b,c){var f=this;return this.__ready.then(function(){c=j(c,"getView");for(var g=new e(f.databaseUrl+"_view/"+b),h=0;h<w.length;h++)c[w[h]]&&g.addSearch(w[h],JSON.stringify(c[w[h]]));return g=g.normalize().href(),d.get(g).withCredentials().then(function(b){if(b&&b.body&&200==b.status&&(c.filter&&(b.body=b.body.filter(c.filter)),c.varName)){f.variables[c.varName]={type:"view",requestUrl:g,data:b.body};for(var d=0;d<b.body.length;d++)f._typeUrl(b.body[d].$content,b.body[d]);return a.createData(c.varName,b.body).then(function(a){for(var b=0;b<a.length;b++)a.traceSync([b]);return a})}return b.body}).then(l(f,c)).catch(k(f,c))})}},{key:"document",value:function(b,c){var d=this;return this.get(b).then(function(b){if(b){if(c.varName){d.variables[c.varName]={type:"document",data:b},d._typeUrl(b.$content,b);var e=new i("roc-documents");return a.createData(c.varName,b).then(function(a){return a.onChange(function(){e.set(a._id,a.resurrect())}),e.get(a._id).then(function(c){c&&(c._rev===b._rev?d._updateByUuid(a._id,c):e.delete(a._id))}),a})}return b}})}},{key:"get",value:function(a,b){var c=this;return this.__ready.then(function(){var e=o(a);return b=j(b,"get"),b.fromCache?c._findByUuid(e):d.get(c.entryUrl+"/"+e).withCredentials().end().then(function(a){return a.body&&200==a.status?(c._defaults(a.body.$content),b.noUpdate||c._updateByUuid(e,a.body),a.body):void 0}).catch(k(c,b))})}},{key:"getById",value:function(a,b){var c=this;return this.__ready.then(function(){b=j(b,"get");var d=c._findById(a);return!d||b.fromCache?d:c.get(d).catch(k(c,b))})}},{key:"create",value:function(a,b){var c=this;return this.__ready.then(function(){return b=j(b,"create"),a.$kind||(a.$kind=c.kind),c._defaults(a.$content),d.post(c.entryUrl).withCredentials().send(a).then(l(c,b)).then(function(a){return!a.body||200!=a.status&&201!=a.status?void 0:c.get(a.body.id)}).then(function(a){if(a){c._typeUrl(a.$content,a);for(var b=Object.keys(c.variables),d=0;d<b.length;d++){var e=c.variables[b[d]];if("view"===e.type){var f=e.data.length;e.data.push(a),e.data.traceSync([f]),e.data.triggerChange()}}return a}}).catch(k(c,b))})}},{key:"update",value:function(a,b){var c=this;return this.__ready.then(function(){b=j(b,"update");var e=DataObject.resurrect(a);return c._untypeUrl(e.$content),d.put(c.entryUrl+"/"+String(a._id)).withCredentials().send(e).then(l(c,b)).then(function(b){return b.body&&200==b.status&&(a._rev=b.body.rev,a.$creationDate=b.body.$creationDate,a.$modificationDate=b.body.$modificationDate,c._updateByUuid(a._id,a)),a}).catch(k(c,b))})}},{key:"deleteAttachment",value:function(a,b,c){var d=this;return this.__ready.then(function(){return a&&a._attachments?(c=j(c,"deleteAttachment"),Array.isArray(b)&&0===b.length?a:(Array.isArray(b)||(b=[b]),b=b.map(String),d.get(a,{fromCache:!0}).then(function(a){d._deleteFilename(a.$content,b);for(var c=0;c<b.length;c++)delete a._attachments[b[c]];var e=d._getCdb(o(a));return e.remove(b).then(function(){return d.get(a,{noUpdate:!0}).then(function(b){return a._rev=b._rev,a._attachments=b._attachments,a.$creationDate=b.$creationDate,a.$modificationDate=b.$modificationDate,a.triggerChange(),a})})}).then(l(d,c)).catch(k(d,c)))):void 0})}},{key:"removeAttachment",value:function(a,b,c){return this.deleteAttachment(a,b,c)}},{key:"unattach",value:function(a,b,c){var d=this;return this.__ready.then(function(){if(c=j(c,"deleteAttachment"),!d.processor)throw new Error("no processor");if(!b.__parent)throw new Error("row must be linked to parent for unattach to work");var e=b.__parent,g=e.indexOf(b);if(-1===g)return void console.warn("element to unattach not found");var h=d._findFilename(b);h=h.map(function(a){return String(a.filename)}),e.splice(g,1);var i=d._findFilename(a.$content,h);return i=i.map(function(a){return String(a.filename)}),h=f.difference(h,i),d.deleteAttachment(a,h,c).then(function(){return e.splice(g,1),e.triggerChange(),a})})}},{key:"attach",value:function(a,c,d,e){var f=this;return this.__ready.then(function(){var g=j(e,"attach"),h=Promise.resolve();return d.filename||(h=b.enterValue("Enter a filename")),h.then(function(b){if(b&&(d.filename=b),d.filename){d.filename=f.processor.getFilename(a,d.filename);var g;return b&&(g=d.contentType,d.contentType=void 0),q(d,g),f.get(c,{fromCache:!0}).then(function(b){return f.addAttachment(b,d,j(e,"addAttachment")).then(function(b){if(!f.processor)throw new Error("no processor");return f.processor.process(a,b.$content,d),f._typeUrl(b.$content,b),b.triggerChange(),b})})}}).then(l(f,g)).catch(k(f,g))})}},{key:"getAttachment",value:function(a,b,c){var d=this;return this.__ready.then(function(){var e=o(a);c=j(c,"getAttachment");var f=d._getCdb(e);return f.get(b).catch(k(d,c))})}},{key:"getAttachmentList",value:function(a){var b=this;return this.__ready.then(function(){var c=o(a),d=b._getCdb(c);return d.list()})}},{key:"addAttachment",value:function(a,c,d){var e=this;return this.__ready.then(function(){var f=Promise.resolve(!0);return c=DataObject.resurrect(c),1===c.length&&(c=c[0]),Array.isArray(c)||(c.filename?c=[c]:f=b.enterValue("Enter a filename").then(function(a){if(a&&(c.filename=a),c.filename){var b=c.contentType;return c.contentType=void 0,q(c,b),c=[c],a}})),c.forEach(function(a){q(a)}),f.then(function(b){return b?e.get(a,{fromCache:!0}).then(function(a){var b=o(a);d=j(d,"addAttachment");var f=e._getCdb(b);return f.inlineUploads(c).then(function(){return e.get(b,{noUpdate:!0})}).then(function(b){return a._rev=b._rev,a._attachments=b._attachments,a.$creationDate=b.$creationDate,a.$modificationDate=b.$modificationDate,a.triggerChange(),a})}).then(l(e,d)).catch(k(e,d)):void 0})})}},{key:"addAttachmentById",value:function(a,b,c){var d=this;return this.__ready.then(function(){var e=d._findById(a);if(e)return d.addAttachment(e._id,b,c)})}},{key:"delete",value:function(a,b){var c=this;return this.__ready.then(function(){var e=o(a);return b=j(b,"delete"),d.del(c.entryUrl+"/"+e).withCredentials().then(l(c,b)).then(function(a){if(a.body&&200==a.status)for(var b in c.variables){var d=c._findIndexByUuid(e,b);-1!==d&&(c.variables[b].data.splice(d,1),c.variables[b].data.triggerChange())}return a.body}).catch(k(c,b))})}},{key:"remove",value:function(a,b){return this.delete(a,b)}},{key:"_getCdb",value:function(a){var b=this.entryUrl+"/"+String(a);return new g(b)}},{key:"_findByUuid",value:function(a,b){if(void 0===b){var c;for(var d in this.variables)if(c=this._findByUuid(a,d))return c;return null}return this.variables[b]?"view"===this.variables[b].type?this.variables[b].data.find(function(b){return String(b._id)===String(a)}):"document"===this.variables[b].type&&String(this.variables[b].data._id)===String(a)?this.variables[b].data:void 0:null}},{key:"_findById",value:function(a,b){if(void 0===b){var c;for(var d in this.variables)if(c=this._findById(a,d))return c;return null}return this.variables[b]?(a=DataObject.resurrect(a),"document"===this.variables[b].type&&f.isEqual(DataObject.resurrect(this.variables[b].data.$id),a)?this.variables[b].data:"view"===this.variables[b].type?this.variables[b].data.find(function(b){return f.isEqual(a,DataObject.resurrect(b.$id))}):null):null}},{key:"_findIndexByUuid",value:function(a,b){return this.variables[b]?"document"===this.variables[b].type?-1:this.variables[b].data.findIndex(function(b){return String(b._id)===String(a)}):-1}},{key:"_updateByUuid",value:function(a,b){for(var c in this.variables)if("view"===this.variables[c].type){var d=this._findIndexByUuid(a,c);if(-1!==d){this._typeUrl(b.$content,b);var e=this.variables[c].data.getChildSync([d]);this._updateDocument(e,b)}}else if("document"===this.variables[c].type){a=String(a);var f=this.variables[c].data._id;if(a===f){this._typeUrl(b.$content,b);var g=this.variables[c].data;this._updateDocument(g,b)}}}},{key:"_updateDocument",value:function(a,b){if(a&&b){for(var c=Object.keys(b),d=0;d<c.length;d++){var e=c[d];a[e]=b[e]}a.triggerChange()}}},{key:"_defaults",value:function(a){if(this.processor){var b=this.kind;b&&this.processor.defaults(b,a)}}},{key:"_traverseFilename",value:function(a,b){var c,d=DataObject.getType(a);if("array"===d)for(c=0;c<a.length;c++)this._traverseFilename(a[c],b);else if("object"===d)if(a.filename)b(a);else{var e=Object.keys(a);for(c=0;c<e.length;c++)this._traverseFilename(a[e[c]],b)}}},{key:"_findFilename",value:function(a,b){var c=[];return Array.isArray(b)||"undefined"==typeof b||(b=[b]),this._traverseFilename(a,function(a){"undefined"==typeof b?c.push(a):-1!==b.indexOf(String(a.filename))&&c.push(a)}),c}},{key:"_deleteFilename",value:function(a,b){for(var c=this._findFilename(a,b),d=0;d<c.length;d++)delete c[d].filename}},{key:"_untypeUrl",value:function(a){this._traverseFilename(a,function(a){a.data&&delete a.data})}},{key:"_typeUrl",value:function(a,b){var d=this;this._traverseFilename(a,function(a){var e=String(a.filename);if(b._attachments){var f=b._attachments[e];if(f){var g,h=f.content_type,i=c.contentTypeToType(h);g=-1!==z.indexOf(i)?"value":"url",a.data={type:i},a.data[g]=d.entryUrl+"/"+b._id+"/"+a.filename}}})}}]),h}(),z=["gif","tiff","jpeg","jpg","png"];return y});