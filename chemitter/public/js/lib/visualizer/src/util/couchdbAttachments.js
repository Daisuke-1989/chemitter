"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();define(["src/util/versioning","superagent","src/util/util"],function(a,b,c){function d(a){for(var b,c=Math.min(100,a.length),d=0;c>d;d++)if(";"===a[d]){b=d+1;break}var e=a.slice(b,b+7);if(b&&"base64,"===e)return b+=7,a.slice(b);throw new Error("Could not parse dataurl")}function e(a,c){return a.list().then(function(){if(!Array.isArray(c))throw new TypeError("Argument should be an array");if(0===c.length)return a.list();for(var d=0;d<c.length;d++)delete a.lastDoc._attachments[c[d]];return b.put(a.docUrl).withCredentials().set("Content-Type","application/json").set("Accept","application/json").send(a.lastDoc).then(function(b){return b&&b.body&&b.body.rev?(a.lastDoc._rev=b.body.rev,f(a,a.lastDoc._attachments)):void 0})}).then(function(){return a.refresh()})}function f(a,b){var c=[],d=0;for(var e in b)c.push(b[e]),c[d].name=e,c[d].filename=e,c[d].url=encodeURI(a.docUrl+"/"+e),d++;return a.lastAttachmentsResult=c,c}function g(a){return a.name||a.filename}var h=/^data:([a-z]+\/[a-z]+)?;base64,/,i=function(){function i(){if(_classCallCheck(this,i),0===arguments.length){var b=a.lastLoaded.view.url;if(!b)throw new Error("couchdb attachments initialization failed: No view url");this.docUrl=b.replace(/\/[^\/]+$/,"")}else this.docUrl=arguments[0]}return _createClass(i,[{key:"list",value:function(a){var b=this;return Promise.resolve().then(function(){var c=b.lastDoc&&b.lastDoc._attachments;if(!b.lastDoc&&a)throw new Error("Unreachable");return c||a?(c||(b.lastDoc._attachments={}),b.attachmentsAsArray(b,b.lastDoc._attachments)):b.refresh().then(function(){return b.list(!0)})})}},{key:"inlineUploads",value:function(a){var c=this,e=this.list();return a?e.then(function(){if(!Array.isArray(a))throw new TypeError("options must be an array");for(var b=[],e=function(e){var f=g(a[e]),i=a[e],j=i.data||i.file||i.content;if("string"==typeof j)if("base64"===i.encoding)c.lastDoc._attachments[f]={content_type:i.contentType,data:j};else{var k=h.exec(j.slice(0,64));k?c.lastDoc._attachments[f]={content_type:i.contentType||k[1],data:j.slice(k[0].length)}:c.lastDoc._attachments[f]={content_type:i.contentType,data:btoa(unescape(encodeURIComponent(j)))}}else{if(!(j instanceof Blob))return{v:Promise.reject(new Error("Item must have a valid data or file property"))};!i.contentType&&j.type&&(i.contentType=j.type);var l=new Promise(function(a,b){var c=new FileReader;c.onload=function(b){return a({item:i,base64data:d(b.target.result)})},c.onerror=function(){return b("Error while reading file")},c.readAsDataURL(j)});b.push(l)}},f=0;f<a.length;f++){var i=e(f);if("object"===("undefined"==typeof i?"undefined":_typeof(i)))return i.v}return Promise.all(b)}).then(function(a){for(var d=0;d<a.length;d++){var e=a[d];c.lastDoc._attachments[g(e.item)]={content_type:e.item.contentType,data:e.base64data}}return b.put(c.docUrl).withCredentials().set("Content-Type","application/json").set("Accept","application/json").send(c.lastDoc).end()}).then(function(){return c.refresh()}):e.then(function(){return f(c,c.lastAttachmentsResult)})}},{key:"upload",value:function(a){var d=this,e=a.data||a.file||a.content;return this.list().then(function(){if(!a)throw new Error("Invalid arguments");var f=a.contentType;if(!f&&e instanceof Blob)f=e.type;else{if("string"!=typeof e)throw new Error("Data must be Blob or base64 dataUrl");if("base64"===a.encoding)e=a.data;else{var i=h.exec(e.slice(0,64));i?(e=c.b64toBlob(e.slice(i[0].length),i[1]),f=i[1]):e=new Blob([e],{content_type:a.contentType})}}if(!f)throw new Error("Content-Type unresolved. Cannot upload document without content-type");return b.put(d.docUrl+"/"+g(a)).withCredentials().query({rev:d.lastDoc._rev}).set("Content-Type",f).set("Accept","application/json").send(e).then(function(a){a&&a.body&&a.body.rev&&(d.lastDoc._rev=a.body.rev)})}).then(function(){return d.refresh()})}},{key:"get",value:function(a,c){var d=this;return c=c||{},this.list().then(function(){var e=d.lastDoc._attachments[a];if(!e)throw new Error("The attachment "+a+" does not exist");var f=b.get(d.docUrl+"/"+a).withCredentials();return e&&f.set("Accept",d.lastDoc._attachments[a].content_type),f.query({rev:d.lastDoc._rev}).then(function(a){return c.raw?a.text:a.body})})}},{key:"remove",value:function(a){var c=this;return Array.isArray(a)?e(this,a):this.list().then(function(){if(!c.lastDoc._attachments[a])throw new Error("Cannot remove attachment, attachment does not exist.");return b.del(c.docUrl+"/"+a).withCredentials().query({rev:c.lastDoc._rev}).set("Accept","application/json").then(function(b){if(b&&b.body&&b.body.rev)return c.lastDoc._rev=b.body.rev,delete c.lastDoc._attachments[a],f(c,c.lastDoc._attachments);throw new Error("Unexpected error when removing attachments")})})}},{key:"refresh",value:function(){var a=this;return b.get(this.docUrl).withCredentials().set("Accept","application/json").then(function(b){return a.lastDoc=b.body,f(a,b.body._attachments)})}},{key:"fetchList",value:function(){return this.refresh()}},{key:"attachmentsAsArray",value:function(){var a=[],b=0;for(var c in this.lastDoc._attachments)a.push(this.lastDoc._attachments[c]),a[b].name=c,a[b].url=encodeURI(this.docUrl+"/"+c),b++;return this.lastAttachmentsResult=a,a}},{key:"uploads1",value:function(a){var c=this;if(!Array.isArray(a))throw new Error("uploads expects an array as parameter");for(var d=b.post(this.docUrl).withCredentials(),e=0;e<a.length;e++){var f=a[e];d.attach("_attachments",f,g(f))}return d.field("_rev",this.lastDoc._rev),d.end().then(function(a){if(201!==a.status)throw new Error("Error uploading attachments, couchdb returned status code "+a.status);return c.refresh()})}}]),i}();return i});